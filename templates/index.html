<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALARM L√ÅSER - CENTRO DE CONTROL</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Bebas+Neue&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0a0a0a; color: #00ff41; font-family: 'Roboto Mono', monospace; }
    .status-safe { background: linear-gradient(135deg, #004d00, #002600); border: 3px solid #00ff41; box-shadow: 0 0 30px rgba(0,255,65,0.6); }
    .status-alert { background: linear-gradient(135deg, #660000, #330000); border: 3px solid #ff0033; box-shadow: 0 0 50px rgba(255,0,51,0.8); animation: alerta 1.2s infinite; }
    .status-warning { background: linear-gradient(135deg, #663300, #331a00); border: 3px solid #ff9900; box-shadow: 0 0 30px rgba(255,153,0,0.6); }
    @keyframes alerta { 0%,100% { opacity: 1; } 50% { opacity: 0.8; } }
    .blink { animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slideUp { animation: slideUp 0.5s ease-out; }
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
    .animate-float { animation: float 3s ease-in-out infinite; }
  </style>
</head>
<body class="min-h-screen">

  <!-- HEADER -->
  <header class="bg-black border-b-4 border-green-500 text-center py-4 md:py-6 px-4">
    <h1 class="text-4xl sm:text-6xl md:text-8xl font-bold tracking-wider" style="font-family: 'Bebas Neue', cursive; color: #00ff41; text-shadow: 0 0 20px #00ff41;">
      ALARM L√ÅSER
    </h1>
    <p class="text-sm sm:text-lg md:text-xl mt-2 text-green-400">Sistema Perimetral de Alta Seguridad - Dashboard de Control</p>
  </header>

  <!-- DASHBOARD ESTILO POWER BI -->
  <div class="container mx-auto px-2 sm:px-4 py-4 md:py-8">
    
    <!-- TARJETAS DE KPIs -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-4 md:mb-8">
      <!-- Estado del Sistema -->
      <div id="mainStatus" class="status-safe rounded-xl md:rounded-2xl p-3 md:p-6 shadow-2xl transform hover:scale-105 transition duration-300 animate-slideUp">
        <div class="text-xs md:text-sm opacity-70 mb-1 md:mb-2">ESTADO</div>
        <div class="text-2xl md:text-4xl font-bold mb-1 md:mb-2" id="statusText">SEGURO</div>
        <div class="text-xs opacity-60 hidden sm:block">Operativo</div>
      </div>

      <!-- Total de Eventos -->
      <div class="bg-gradient-to-br from-blue-900 to-blue-700 rounded-xl md:rounded-2xl p-3 md:p-6 border-2 border-blue-400 shadow-2xl transform hover:scale-105 transition duration-300 animate-slideUp" style="animation-delay: 0.1s">
        <div class="text-xs md:text-sm text-blue-200 mb-1 md:mb-2">EVENTOS</div>
        <div class="text-2xl md:text-4xl font-bold text-white" id="totalEventos">0</div>
        <div class="text-xs text-blue-300 hidden sm:block">Registros</div>
      </div>

      <!-- Alertas Cr√≠ticas -->
      <div class="bg-gradient-to-br from-red-900 to-red-700 rounded-xl md:rounded-2xl p-3 md:p-6 border-2 border-red-400 shadow-2xl transform hover:scale-105 transition duration-300 animate-slideUp" style="animation-delay: 0.2s">
        <div class="text-xs md:text-sm text-red-200 mb-1 md:mb-2">ALERTAS</div>
        <div class="text-2xl md:text-4xl font-bold text-white" id="alertasCriticas">0</div>
        <div class="text-xs text-red-300 hidden sm:block">Cr√≠ticas</div>
      </div>

      <!-- √öltima Detecci√≥n -->
      <div class="bg-gradient-to-br from-purple-900 to-purple-700 rounded-xl md:rounded-2xl p-3 md:p-6 border-2 border-purple-400 shadow-2xl transform hover:scale-105 transition duration-300 animate-slideUp" style="animation-delay: 0.3s">
        <div class="text-xs md:text-sm text-purple-200 mb-1 md:mb-2">√öLTIMA</div>
        <div class="text-lg md:text-2xl font-bold text-white" id="ultimaDeteccion">--:--:--</div>
        <div class="text-xs text-purple-300 hidden sm:block">Hora Per√∫</div>
      </div>
    </div>

    <!-- PANEL PRINCIPAL -->
    <div class="bg-gray-900 rounded-xl md:rounded-2xl border-2 border-green-500 p-4 md:p-8 mb-4 md:mb-8 shadow-2xl animate-slideUp" style="animation-delay: 0.4s">
      <h2 class="text-xl md:text-3xl font-bold mb-4 md:mb-6 text-green-400">
        üìä AN√ÅLISIS EN TIEMPO REAL
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <!-- Gr√°fico Visual de Estado -->
        <div class="bg-black bg-opacity-50 rounded-lg md:rounded-xl p-4 md:p-6 border border-green-700">
          <h3 class="text-base md:text-xl mb-3 md:mb-4 text-green-300">Estado de Seguridad</h3>
          <div id="estadoVisual" class="flex items-center justify-center h-32 md:h-40">
            <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-green-500 shadow-lg shadow-green-500/50 flex items-center justify-center animate-float">
              <span class="text-3xl md:text-4xl">üõ°Ô∏è</span>
            </div>
          </div>
        </div>

        <!-- Indicadores de Actividad -->
        <div class="bg-black bg-opacity-50 rounded-lg md:rounded-xl p-4 md:p-6 border border-green-700">
          <h3 class="text-base md:text-xl mb-3 md:mb-4 text-green-300">Actividad Reciente</h3>
          <div class="space-y-2 md:space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm md:text-base text-gray-400">Eventos hoy:</span>
              <span class="text-xl md:text-2xl font-bold text-green-400" id="eventosHoy">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm md:text-base text-gray-400">√öltima hora:</span>
              <span class="text-xl md:text-2xl font-bold text-blue-400" id="eventosHora">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm md:text-base text-gray-400">Estado l√°ser:</span>
              <span class="text-base md:text-xl font-bold text-green-400 animate-pulse">‚óè ACTIVO</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TABLA DE EVENTOS -->
    <div class="bg-gray-900 rounded-xl md:rounded-2xl border-2 border-green-500 overflow-hidden shadow-2xl animate-slideUp" style="animation-delay: 0.5s">
      <div class="bg-green-900 px-3 md:px-6 py-3 md:py-4 text-lg md:text-2xl font-bold text-black flex items-center justify-between">
        <span>üìã REGISTRO DE EVENTOS</span>
        <span class="text-xs md:text-sm font-normal text-green-200 hidden sm:inline">Actualizaci√≥n autom√°tica</span>
      </div>
      <div class="max-h-64 md:max-h-96 overflow-y-auto overflow-x-auto">
        <table class="w-full text-left text-xs md:text-base">
          <thead class="bg-black bg-opacity-50 sticky top-0">
            <tr class="text-green-400">
              <th class="px-2 md:px-6 py-2 md:py-4 whitespace-nowrap">FECHA Y HORA</th>
              <th class="px-2 md:px-6 py-2 md:py-4">EVENTO</th>
              <th class="px-2 md:px-6 py-2 md:py-4 hidden sm:table-cell">ESTADO</th>
            </tr>
          </thead>
          <tbody id="log" class="divide-y divide-green-900"></tbody>
        </table>
      </div>
    </div>

    <!-- FOOTER CON ANIMACI√ìN -->
    <div class="text-center mt-4 md:mt-8 space-y-2 md:space-y-3 animate-slideUp" style="animation-delay: 0.6s">
      <div class="flex items-center justify-center space-x-2 md:space-x-4">
        <div class="w-2 h-2 md:w-3 md:h-3 bg-green-500 rounded-full animate-pulse"></div>
        <span class="text-sm md:text-base text-green-400">Sistema operativo</span>
        <div class="w-2 h-2 md:w-3 md:h-3 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.5s"></div>
      </div>
      <div class="text-sm md:text-base text-green-400">
        √öltima actualizaci√≥n: <span id="ultima" class="font-bold text-green-300">00:00:00</span>
      </div>
      <div class="text-gray-500 text-xs md:text-sm">
        Powered by Arduino ESP32 | Tiempo Real | Alta Seguridad
      </div>
    </div>
  </div>

  <script>
    const mainStatus = document.getElementById('mainStatus');
    const statusText = document.getElementById('statusText');
    const log = document.getElementById('log');
    const ultima = document.getElementById('ultima');
    const totalEventos = document.getElementById('totalEventos');
    const alertasCriticas = document.getElementById('alertasCriticas');
    const ultimaDeteccion = document.getElementById('ultimaDeteccion');
    const eventosHoy = document.getElementById('eventosHoy');
    const eventosHora = document.getElementById('eventosHora');
    const estadoVisual = document.getElementById('estadoVisual');

    let ultimaActualizacion = Date.now();
    let estadoAlerta = false;

    function parsearFechaBaseDatos(timestamp) {
      try {
        // Formato: "2025-11-17 18:29:56.883959" (ya viene en hora de Per√∫ desde el servidor)
        let fecha;
        
        // Si viene en formato ISO (YYYY-MM-DD HH:MM:SS)
        if (timestamp.includes('-') && timestamp.split('-')[0].length === 4) {
          // Formato: 2025-11-17 18:29:56.883959
          const partes = timestamp.split(' ');
          const fechaParte = partes[0]; // 2025-11-17
          const horaParte = partes[1].split('.')[0]; // 18:29:56
          // Crear fecha como si fuera local (ya que viene en hora de Per√∫)
          fecha = new Date(`${fechaParte}T${horaParte}`);
        } 
        // Si viene en formato DD/MM/YYYY
        else if (timestamp.includes('/')) {
          // Formato: 18:29:56 17/11/2025
          const partes = timestamp.split(' ');
          const hora = partes[0]; // 18:29:56
          const fechaPartes = partes[1].split('/'); // [17, 11, 2025]
          const dia = fechaPartes[0];
          const mes = fechaPartes[1];
          const anio = fechaPartes[2];
          fecha = new Date(`${anio}-${mes}-${dia}T${hora}`);
        }
        
        if (!fecha || isNaN(fecha.getTime())) {
          console.error('No se pudo parsear:', timestamp);
          return null;
        }
        
        return fecha;
      } catch (error) {
        console.error('Error parseando fecha:', error, timestamp);
        return null;
      }
    }

    function formatearHoraPeru(timestamp) {
      const fecha = parsearFechaBaseDatos(timestamp);
      if (!fecha) return 'Error en fecha';
      
      // Formatear directamente sin conversi√≥n de zona horaria (ya viene en hora de Per√∫)
      const dia = String(fecha.getDate()).padStart(2, '0');
      const mes = String(fecha.getMonth() + 1).padStart(2, '0');
      const anio = fecha.getFullYear();
      const hora = String(fecha.getHours()).padStart(2, '0');
      const minuto = String(fecha.getMinutes()).padStart(2, '0');
      const segundo = String(fecha.getSeconds()).padStart(2, '0');
      
      return `${dia}/${mes}/${anio} ${hora}:${minuto}:${segundo}`;
    }

    function formatearHoraCorta(timestamp) {
      const fecha = parsearFechaBaseDatos(timestamp);
      if (!fecha) return '--:--:--';
      
      const hora = String(fecha.getHours()).padStart(2, '0');
      const minuto = String(fecha.getMinutes()).padStart(2, '0');
      const segundo = String(fecha.getSeconds()).padStart(2, '0');
      
      return `${hora}:${minuto}:${segundo}`;
    }

    function verificarTimeout() {
      const ahora = Date.now();
      const tiempoTranscurrido = ahora - ultimaActualizacion;
      
      // Si han pasado m√°s de 5 segundos sin recibir datos, volver al estado normal
      if (tiempoTranscurrido > 5000 && estadoAlerta) {
        estadoAlerta = false;
        actualizarEstadoUI(false);
      }
    }

    function actualizarEstadoUI(intrusoDetectado) {
      if (intrusoDetectado) {
        mainStatus.className = "status-alert rounded-xl md:rounded-2xl p-3 md:p-6 shadow-2xl transform hover:scale-105 transition duration-300";
        statusText.textContent = "¬°ALERTA!";
        statusText.className = "text-2xl md:text-4xl font-bold mb-1 md:mb-2 blink text-white";
        
        estadoVisual.innerHTML = `
          <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-red-500 shadow-lg shadow-red-500/50 flex items-center justify-center blink animate-float">
            <span class="text-3xl md:text-4xl">üö®</span>
          </div>
        `;
        
        alertasCriticas.classList.add('blink');
      } else {
        mainStatus.className = "status-safe rounded-xl md:rounded-2xl p-3 md:p-6 shadow-2xl transform hover:scale-105 transition duration-300";
        statusText.textContent = "SEGURO";
        statusText.className = "text-2xl md:text-4xl font-bold mb-1 md:mb-2";
        
        estadoVisual.innerHTML = `
          <div class="w-24 h-24 md:w-32 md:h-32 rounded-full bg-green-500 shadow-lg shadow-green-500/50 flex items-center justify-center animate-float">
            <span class="text-3xl md:text-4xl">üõ°Ô∏è</span>
          </div>
        `;
        
        alertasCriticas.classList.remove('blink');
      }
    }

    async function actualizar() {
      try {
        const res = await fetch('/alerta?' + Date.now());
        const data = await res.json();

        ultimaActualizacion = Date.now();
        log.innerHTML = '';
        let intruso = false;
        let contadorCriticas = 0;
        let ultimaHora = '';

        // Contar eventos de hoy y √∫ltima hora
        const ahora = new Date();
        const haceUnaHora = new Date(ahora.getTime() - 60 * 60 * 1000);
        const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
        
        let eventosHoyCount = 0;
        let eventosHoraCount = 0;

        data.alertas.forEach((a, index) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-green-900 hover:bg-opacity-20 transition animate-slideUp';
          tr.style.animationDelay = `${index * 0.05}s`;

          const horaPeru = formatearHoraPeru(a.timestamp);
          
          // Contar eventos
          const fechaEvento = parsearFechaBaseDatos(a.timestamp);
          if (fechaEvento) {
            if (fechaEvento >= hoy) eventosHoyCount++;
            if (fechaEvento >= haceUnaHora) eventosHoraCount++;
            if (index === 0) ultimaHora = formatearHoraCorta(a.timestamp);
          }

          const esIntruso = a.mensaje.toUpperCase().includes("INTRUSO") || 
                           a.mensaje.toUpperCase().includes("CORTADO") ||
                           a.mensaje.includes("¬°INTRUSO");

          // Solo mostrar en la tabla si es una alerta de intruso (para alertas activas)
          // O mostrar los √∫ltimos 5 eventos normales
          if (esIntruso) {
            intruso = true;
            contadorCriticas++;
            tr.innerHTML = `
              <td class="px-2 md:px-6 py-2 md:py-4 text-red-500 font-bold blink whitespace-nowrap text-xs md:text-base">${horaPeru}</td>
              <td class="px-2 md:px-6 py-2 md:py-4 text-red-400 font-bold text-xs md:text-base">üö® INTRUSO DETECTADO - L√°ser cortado</td>
              <td class="px-2 md:px-6 py-2 md:py-4 hidden sm:table-cell"><span class="bg-red-600 px-2 md:px-3 py-1 rounded-full text-white text-xs blink">CR√çTICO</span></td>
            `;
            log.prepend(tr);
          } else if (!intruso && log.children.length < 10) {
            // Solo mostrar eventos normales si no hay alertas activas
            tr.innerHTML = `
              <td class="px-2 md:px-6 py-2 md:py-4 text-green-300 whitespace-nowrap text-xs md:text-base">${horaPeru}</td>
              <td class="px-2 md:px-6 py-2 md:py-4 text-gray-300 text-xs md:text-base">${a.mensaje}</td>
              <td class="px-2 md:px-6 py-2 md:py-4 hidden sm:table-cell"><span class="bg-green-600 px-2 md:px-3 py-1 rounded-full text-white text-xs">NORMAL</span></td>
            `;
            log.prepend(tr);
          }
        });

        // Actualizar KPIs
        totalEventos.textContent = data.alertas.length;
        alertasCriticas.textContent = contadorCriticas;
        ultimaDeteccion.textContent = ultimaHora || '--:--:--';
        eventosHoy.textContent = eventosHoyCount;
        eventosHora.textContent = eventosHoraCount;

        // Actualizar estado principal solo si hay intruso detectado
        if (intruso) {
          estadoAlerta = true;
        }
        
        actualizarEstadoUI(estadoAlerta);

        ultima.textContent = new Date().toLocaleTimeString('es-PE', { 
          timeZone: 'America/Lima', 
          hour12: false 
        });

      } catch (e) {
        console.error("Error de conexi√≥n:", e);
        ultima.textContent = "Error de conexi√≥n";
        
        // Si hay error de conexi√≥n, verificar si debemos volver al estado normal
        verificarTimeout();
      }
    }

    actualizar();
    setInterval(actualizar, 1000);
    setInterval(verificarTimeout, 1000); // Verificar timeout cada segundo
  </script>
</body>
</html>