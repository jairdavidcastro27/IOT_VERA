<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALARM L√ÅSER - CENTRO DE CONTROL</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Bebas+Neue&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #0a0a0a; color: #00ff41; font-family: 'Roboto Mono', monospace; }
    .status-safe { background: linear-gradient(135deg, #004d00, #002600); border: 3px solid #00ff41; box-shadow: 0 0 30px rgba(0,255,65,0.6); }
    .status-alert { background: linear-gradient(135deg, #660000, #330000); border: 3px solid #ff0033; box-shadow: 0 0 50px rgba(255,0,51,0.8); animation: alerta 1.2s infinite; }
    @keyframes alerta { 0%,100% { opacity: 1; } 50% { opacity: 0.8; } }
    .blink { animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-slideUp { animation: slideUp 0.5s ease-out; }
  </style>
</head>
<body class="min-h-screen">

  <!-- HEADER -->
  <header class="bg-black border-b-4 border-green-500 text-center py-6">
    <h1 class="text-6xl md:text-8xl font-bold tracking-wider" style="font-family: 'Bebas Neue', cursive; color: #00ff41; text-shadow: 0 0 20px #00ff41;">
      ALARM L√ÅSER
    </h1>
    <p class="text-xl mt-2 text-green-400">Sistema Perimetral de Alta Seguridad - Dashboard de Control</p>
  </header>

  <!-- DASHBOARD ESTILO POWER BI -->
  <div class="container mx-auto px-4 py-8">
    
    <!-- TARJETAS DE KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <!-- Estado del Sistema -->
      <div id="mainStatus" class="status-safe rounded-2xl p-6 shadow-2xl transform hover:scale-105 transition duration-300 animate-slideUp">
        <div class="text-sm opacity-70 mb-2">ESTADO DEL SISTEMA</div>
        <div class="text-4xl font-bold mb-2" id="statusText">SEGURO</div>
        <div class="text-xs opacity-60">Armado y operativo</div>
      </div>

      <!-- Total de Eventos -->
      <div class="bg-gradient-to-br from-blue-900 to-blue-700 rounded-2xl p-6 border-2 border-blue-400 shadow-2xl transform hover:scale-105 transition duration-300 animate-slideUp" style="animation-delay: 0.1s">
        <div class="text-sm text-blue-200 mb-2">TOTAL EVENTOS</div>
        <div class="text-4xl font-bold text-white" id="totalEventos">0</div>
        <div class="text-xs text-blue-300">Registros totales</div>
      </div>

      <!-- Alertas Cr√≠ticas -->
      <div class="bg-gradient-to-br from-red-900 to-red-700 rounded-2xl p-6 border-2 border-red-400 shadow-2xl transform hover:scale-105 transition duration-300 animate-slideUp" style="animation-delay: 0.2s">
        <div class="text-sm text-red-200 mb-2">ALERTAS CR√çTICAS</div>
        <div class="text-4xl font-bold text-white" id="alertasCriticas">0</div>
        <div class="text-xs text-red-300">Intrusiones detectadas</div>
      </div>

      <!-- √öltima Detecci√≥n -->
      <div class="bg-gradient-to-br from-purple-900 to-purple-700 rounded-2xl p-6 border-2 border-purple-400 shadow-2xl transform hover:scale-105 transition duration-300 animate-slideUp" style="animation-delay: 0.3s">
        <div class="text-sm text-purple-200 mb-2">√öLTIMA DETECCI√ìN</div>
        <div class="text-2xl font-bold text-white" id="ultimaDeteccion">--:--:--</div>
        <div class="text-xs text-purple-300">Hora de Per√∫</div>
      </div>
    </div>

    <!-- PANEL PRINCIPAL -->
    <div class="bg-gray-900 rounded-2xl border-2 border-green-500 p-8 mb-8 shadow-2xl animate-slideUp" style="animation-delay: 0.4s">
      <h2 class="text-3xl font-bold mb-6 text-green-400">
        üìä AN√ÅLISIS EN TIEMPO REAL
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Gr√°fico Visual de Estado -->
        <div class="bg-black bg-opacity-50 rounded-xl p-6 border border-green-700">
          <h3 class="text-xl mb-4 text-green-300">Estado de Seguridad</h3>
          <div id="estadoVisual" class="flex items-center justify-center h-40">
            <div class="w-32 h-32 rounded-full bg-green-500 animate-pulse shadow-lg shadow-green-500/50 flex items-center justify-center">
              <span class="text-4xl">üõ°Ô∏è</span>
            </div>
          </div>
        </div>

        <!-- Indicadores de Actividad -->
        <div class="bg-black bg-opacity-50 rounded-xl p-6 border border-green-700">
          <h3 class="text-xl mb-4 text-green-300">Actividad Reciente</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-400">Eventos hoy:</span>
              <span class="text-2xl font-bold text-green-400" id="eventosHoy">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400">√öltima hora:</span>
              <span class="text-2xl font-bold text-blue-400" id="eventosHora">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400">Estado del l√°ser:</span>
              <span class="text-xl font-bold text-green-400 animate-pulse">‚óè ACTIVO</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TABLA DE EVENTOS -->
    <div class="bg-gray-900 rounded-2xl border-2 border-green-500 overflow-hidden shadow-2xl animate-slideUp" style="animation-delay: 0.5s">
      <div class="bg-green-900 px-6 py-4 text-2xl font-bold text-black flex items-center justify-between">
        <span>üìã REGISTRO DE EVENTOS</span>
        <span class="text-sm font-normal text-green-200">Actualizaci√≥n autom√°tica</span>
      </div>
      <div class="max-h-96 overflow-y-auto">
        <table class="w-full text-left">
          <thead class="bg-black bg-opacity-50 sticky top-0">
            <tr class="text-green-400 text-lg">
              <th class="px-6 py-4">FECHA Y HORA (PER√ö)</th>
              <th class="px-6 py-4">EVENTO</th>
              <th class="px-6 py-4">ESTADO</th>
            </tr>
          </thead>
          <tbody id="log" class="divide-y divide-green-900"></tbody>
        </table>
      </div>
    </div>

    <!-- FOOTER CON ANIMACI√ìN -->
    <div class="text-center mt-8 space-y-3 animate-slideUp" style="animation-delay: 0.6s">
      <div class="flex items-center justify-center space-x-4">
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
        <span class="text-green-400">Sistema operativo</span>
        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse" style="animation-delay: 0.5s"></div>
      </div>
      <div class="text-green-400">
        √öltima actualizaci√≥n: <span id="ultima" class="font-bold text-green-300">00:00:00</span>
      </div>
      <div class="text-gray-500 text-sm">
        Powered by Arduino ESP32 | Tiempo Real | Alta Seguridad
      </div>
    </div>
  </div>

  <script>
    const mainStatus = document.getElementById('mainStatus');
    const statusText = document.getElementById('statusText');
    const log = document.getElementById('log');
    const ultima = document.getElementById('ultima');
    const totalEventos = document.getElementById('totalEventos');
    const alertasCriticas = document.getElementById('alertasCriticas');
    const ultimaDeteccion = document.getElementById('ultimaDeteccion');
    const eventosHoy = document.getElementById('eventosHoy');
    const eventosHora = document.getElementById('eventosHora');
    const estadoVisual = document.getElementById('estadoVisual');

    function formatearHoraPeru(timestamp) {
      try {
        // Si el timestamp ya incluye zona horaria, usarlo directamente
        let date;
        if (timestamp.includes('UTC') || timestamp.includes('+') || timestamp.includes('-')) {
          date = new Date(timestamp);
        } else {
          // Si no tiene zona horaria, asumir que es UTC
          date = new Date(timestamp + ' UTC');
        }
        
        // Verificar si la fecha es v√°lida
        if (isNaN(date.getTime())) {
          console.error('Fecha inv√°lida:', timestamp);
          return 'Fecha inv√°lida';
        }
        
        return date.toLocaleString('es-PE', {
          timeZone: 'America/Lima',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
      } catch (error) {
        console.error('Error al formatear fecha:', error, timestamp);
        return 'Error en fecha';
      }
    }

    function formatearHoraCorta(timestamp) {
      try {
        let date;
        if (timestamp.includes('UTC') || timestamp.includes('+') || timestamp.includes('-')) {
          date = new Date(timestamp);
        } else {
          date = new Date(timestamp + ' UTC');
        }
        
        if (isNaN(date.getTime())) {
          return '--:--:--';
        }
        
        return date.toLocaleTimeString('es-PE', {
          timeZone: 'America/Lima',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });
      } catch (error) {
        return '--:--:--';
      }
    }

    async function actualizar() {
      try {
        const res = await fetch('/alerta?' + Date.now());
        const data = await res.json();

        log.innerHTML = '';
        let intruso = false;
        let contadorCriticas = 0;
        let ultimaHora = '';

        // Contar eventos de hoy y √∫ltima hora
        const ahora = new Date();
        const haceUnaHora = new Date(ahora.getTime() - 60 * 60 * 1000);
        const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
        
        let eventosHoyCount = 0;
        let eventosHoraCount = 0;

        data.alertas.forEach((a, index) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-green-900 hover:bg-opacity-20 transition animate-slideUp';
          tr.style.animationDelay = `${index * 0.05}s`;

          const horaPeru = formatearHoraPeru(a.timestamp);
          
          // Contar eventos
          try {
            let fechaEvento;
            if (a.timestamp.includes('UTC') || a.timestamp.includes('+') || a.timestamp.includes('-')) {
              fechaEvento = new Date(a.timestamp);
            } else {
              fechaEvento = new Date(a.timestamp + ' UTC');
            }
            
            if (!isNaN(fechaEvento.getTime())) {
              if (fechaEvento >= hoy) eventosHoyCount++;
              if (fechaEvento >= haceUnaHora) eventosHoraCount++;
              if (index === 0) ultimaHora = formatearHoraCorta(a.timestamp);
            }
          } catch (e) {
            console.error('Error procesando fecha:', e);
          }

          if (a.mensaje.toUpperCase().includes("INTRUSO") || a.mensaje.toUpperCase().includes("CORTADO")) {
            intruso = true;
            contadorCriticas++;
            tr.innerHTML = `
              <td class="px-6 py-4 text-red-500 font-bold blink">${horaPeru}</td>
              <td class="px-6 py-4 text-red-400 font-bold">üö® ${a.mensaje.toUpperCase()}</td>
              <td class="px-6 py-4"><span class="bg-red-600 px-3 py-1 rounded-full text-white text-sm blink">CR√çTICO</span></td>
            `;
          } else {
            tr.innerHTML = `
              <td class="px-6 py-4 text-green-300">${horaPeru}</td>
              <td class="px-6 py-4 text-gray-300">${a.mensaje}</td>
              <td class="px-6 py-4"><span class="bg-green-600 px-3 py-1 rounded-full text-white text-sm">NORMAL</span></td>
            `;
          }
          log.prepend(tr);
        });

        // Actualizar KPIs
        totalEventos.textContent = data.alertas.length;
        alertasCriticas.textContent = contadorCriticas;
        ultimaDeteccion.textContent = ultimaHora || '--:--:--';
        eventosHoy.textContent = eventosHoyCount;
        eventosHora.textContent = eventosHoraCount;

        // Actualizar estado principal
        if (intruso) {
          mainStatus.className = "status-alert rounded-2xl p-6 shadow-2xl transform hover:scale-105 transition duration-300";
          statusText.textContent = "¬°ALERTA!";
          statusText.className = "text-4xl font-bold mb-2 blink text-white";
          
          // Cambiar indicador visual
          estadoVisual.innerHTML = `
            <div class="w-32 h-32 rounded-full bg-red-500 animate-pulse shadow-lg shadow-red-500/50 flex items-center justify-center blink">
              <span class="text-4xl">üö®</span>
            </div>
          `;
          
          // Hacer parpadear el contador de alertas cr√≠ticas
          alertasCriticas.classList.add('blink');
        } else {
          mainStatus.className = "status-safe rounded-2xl p-6 shadow-2xl transform hover:scale-105 transition duration-300";
          statusText.textContent = "SEGURO";
          statusText.className = "text-4xl font-bold mb-2";
          
          // Restaurar indicador visual
          estadoVisual.innerHTML = `
            <div class="w-32 h-32 rounded-full bg-green-500 animate-pulse shadow-lg shadow-green-500/50 flex items-center justify-center">
              <span class="text-4xl">üõ°Ô∏è</span>
            </div>
          `;
          
          alertasCriticas.classList.remove('blink');
        }

        // Actualizar hora actual
        ultima.textContent = new Date().toLocaleTimeString('es-PE', { 
          timeZone: 'America/Lima', 
          hour12: false 
        });

      } catch (e) {
        console.error("Error de conexi√≥n:", e);
        ultima.textContent = "Error de conexi√≥n";
      }
    }

    // Iniciar
    actualizar();
    setInterval(actualizar, 1000);
  </script>
</body>
</html>