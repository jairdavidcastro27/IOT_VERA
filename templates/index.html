<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ALARM LASER - ULTRA RÁPIDO</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    body { background: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; padding: 20px; }
    h1 { font-size: 3em; text-shadow: 0 0 20px #0f0; margin-bottom: 10px; }
    .status {
      font-size: 2.5em; padding: 20px; border-radius: 15px; margin: 20px auto;
      max-width: 900px; transition: all 0.3s; font-weight: bold;
    }
    .status.safe { background: rgba(0,255,0,0.2); border: 4px solid #0f0; }
    .status.alert { 
      background: rgba(255,0,0,0.6); border: 4px solid #f00; color: #fff;
      animation: pulso 0.8s infinite; text-shadow: 0 0 15px #f00;
    }
    @keyframes pulso { 50% { opacity: 0.7; } }
    .log {
      background: #111; padding: 20px; border-radius: 15px; max-width: 900px;
      margin: 20px auto; text-align: left; border: 2px solid #0f0; max-height: 70vh; overflow-y: auto;
    }
    .entry { padding: 10px; border-bottom: 1px dashed #0f0; font-size: 1.1em; }
    .time { color: #0ff; font-weight: bold; }
  </style>
</head>
<body>
  <h1>ALARM LASER SYSTEM</h1>
  <div id="status" class="status safe">Sistema armado - Todo seguro</div>
  
  <h2>Últimas alertas (actualiza cada segundo)</h2>
  <div id="log" class="log"></div>

<script>
  const status = document.getElementById('status');
  const log = document.getElementById('log');

  // === FUNCIÓN PARA CONVERTIR UTC → HORA DE PERÚ (Lima) ===
  function horaPeru(utcString) {
    const date = new Date(utcString + " UTC"); // fuerza que sea UTC
    return date.toLocaleString('es-PE', {
      timeZone: 'America/Lima',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    }).replace(',', '');
  }

  async function actualizarTodo() {
    try {
      const res = await fetch('/alerta?' + Date.now());
      const data = await res.json();

      log.innerHTML = '';
      let hayIntruso = false;

      data.alertas.forEach(a => {
        const div = document.createElement('div');
        div.className = 'entry';
        
        // ← AQUÍ LA MAGIA: convierte la hora UTC a hora peruana
        const horaPeruana = horaPeru(a.timestamp);
        
        div.innerHTML = `<span class="time">[${horaPeruana}]</span> ${a.mensaje}`;
        log.prepend(div);

        if (a.mensaje.toUpperCase().includes("INTRUSO") || 
            a.mensaje.toUpperCase().includes("CORTADO") || 
            a.mensaje.toUpperCase().includes("DETECTADO")) {
          hayIntruso = true;
        }
      });

      status.textContent = hayIntruso ? "¡INTRUSO DETECTADO!" : "Sistema armado - Todo seguro";
      status.className = hayIntruso ? "status alert" : "status safe";

    } catch (err) {
      console.log("Error temporal...");
    }
  }

  actualizarTodo();
  setInterval(actualizarTodo, 1000); // cada segundo
</script>
</body>
</html>